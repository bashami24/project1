feature_snapshot as
(
SELECT *
,CASE WHEN STATUS_NAME = 'Closed' and CLOSE_TIMESTAMP between '2022-11-01'and '2022-11-30 23:59:59'and GROSS_LOSS_PAYMENT_AMOUNT_SINCE_INCEPTION != 0 THEN 1 ELSE 0 END AS CLOSED_WITH_GROSS_LOSS_PAYMENT_COUNT
,CASE WHEN STATUS_NAME = 'Closed' and CLOSE_TIMESTAMP between '2022-11-01'and '2022-11-30 23:59:59'and NET_LOSS_PAYMENT_AMOUNT_SINCE_INCEPTION != 0 THEN 1 ELSE 0 END AS CLOSED_WITH_NET_LOSS_PAYMENT_COUNT
,CASE WHEN STATUS_NAME = 'Closed' and CLOSE_TIMESTAMP between '2022-11-01'and '2022-11-30 23:59:59'and GROSS_LOSS_PAYMENT_AMOUNT_SINCE_INCEPTION = 0 THEN 1 ELSE 0 END AS CLOSED_WITHOUT_GROSS_LOSS_PAYMENT_COUNT
,CASE WHEN STATUS_NAME = 'Closed' and CLOSE_TIMESTAMP between '2022-11-01'and '2022-11-30 23:59:59'and NET_LOSS_PAYMENT_AMOUNT_SINCE_INCEPTION = 0 THEN 1 ELSE 0 END AS CLOSED_WITHOUT_NET_LOSS_PAYMENT_COUNT

FROM (
SELECT

CLAIM_NUMBER
,CLAIM_PUBLICID_NK
,EXPOSURE_PUBLICID_NK
,CLAIM_SYMBOL_CODE
,S160_COVERAGE_CODE
,CREATE_TIMESTAMP
,RECORD_BEGIN_TIMESTAMP
,'2022-11-01'
,'2022-11-30 23:59:59'
,ACCOUNTING_TIMESTAMP
,RECORD_END_TIMESTAMP
,CLOSE_TIMESTAMP
,REOPEN_TIMESTAMP
,STATUS_NAME
,RESERVE_TYPE_NAME
,PRIOR_RESERVE_TYPE_NAME
,FEATURE_RESERVE_STATUS_CODE
,PENDING_OR_CLOSED
,NEW_REPORTED_COUNT_1 AS NEW_REPORTED_COUNT
,NEW_REOPENED_REPORTED_COUNT_1 AS NEW_REOPENED_REPORTED_COUNT
,NEW_CLOSED_COUNT_1 AS NEW_CLOSED_COUNT
,CASE WHEN PENDING_OR_CLOSED = 'Pending' THEN 1 ELSE 0 END AS PENDING_COUNT

,CASE WHEN STATUS_NAME in ('Open','Closed') AND RANK_ORDER = 1 THEN LOSS_PAYMENT_AMOUNT_CM
      WHEN STATUS_NAME  = 'Closed' and RANK_ORDER <> 1 THEN LOSS_PAYMENT_AMOUNT_SINCE_INCEPTION_CM
  ELSE LOSS_PAYMENT_AMOUNT_SINCE_REOPEN_CM END AS GROSS_LOSS_PAYMENT_AMOUNT
,CASE WHEN ACCOUNTING_TIMESTAMP IS NOT NULL THEN LOSS_PAYMENT_AMOUNT_SINCE_INCEPTION ELSE LOSS_PAYMENT_AMOUNT_SINCE_INCEPTION_1 END AS GROSS_LOSS_PAYMENT_AMOUNT_SINCE_INCEPTION
,CASE WHEN ACCOUNTING_TIMESTAMP IS NOT NULL THEN LOSS_PAYMENT_AMOUNT_SINCE_LAST_REOPEN ELSE LOSS_PAYMENT_AMOUNT_SINCE_LAST_REOPEN_1 END AS GROSS_LOSS_PAYMENT_AMOUNT_SINCE_LAST_REOPEN

,CASE WHEN STATUS_NAME in ('Open','Closed') AND RANK_ORDER = 1 THEN EXPENSE_PAYMENT_AMOUNT_CM
      WHEN STATUS_NAME  = 'Closed' and RANK_ORDER <> 1 THEN EXPENSE_PAYMENT_AMOUNT_SINCE_INCEPTION_CM
  ELSE EXPENSE_PAYMENT_AMOUNT_SINCE_REOPEN_CM END AS EXPENSE_PAYMENT_AMOUNT
,CASE WHEN ACCOUNTING_TIMESTAMP IS NOT NULL THEN EXPENSE_PAYMENT_AMOUNT_SINCE_INCEPTION ELSE EXPENSE_PAYMENT_AMOUNT_SINCE_INCEPTION_1 END AS EXPENSE_PAYMENT_AMOUNT_SINCE_INCEPTION
,CASE WHEN ACCOUNTING_TIMESTAMP IS NOT NULL THEN EXPENSE_PAYMENT_AMOUNT_SINCE_LAST_REOPEN ELSE EXPENSE_PAYMENT_AMOUNT_SINCE_LAST_REOPEN_1 END AS EXPENSE_PAYMENT_AMOUNT_SINCE_LAST_REOPEN

,CASE WHEN ACCOUNTING_TIMESTAMP IS NOT NULL AND STATUS_NAME in ('Open','Reopened') THEN CASE_RESERVE_LOSS_AMOUNT
	  WHEN ACCOUNTING_TIMESTAMP IS NULL AND STATUS_NAME in ('Open','Reopened') THEN CASE_RESERVE_LOSS_AMOUNT_1 ELSE 0 END AS CASE_RESERVE_LOSS_AMOUNT
,CASE WHEN ACCOUNTING_TIMESTAMP IS NOT NULL AND STATUS_NAME in ('Open','Reopened') THEN CASE_RESERVE_EXPENSE_AMOUNT
	  WHEN ACCOUNTING_TIMESTAMP IS NULL AND STATUS_NAME in ('Open','Reopened') THEN CASE_RESERVE_EXPENSE_AMOUNT_1 ELSE 0 END AS CASE_RESERVE_EXPENSE_AMOUNT


,CASE WHEN STATUS_NAME in ('Open','Closed') AND RANK_ORDER = 1 THEN SALVAGE_RECOVERY_AMOUNT_CM
      WHEN STATUS_NAME  = 'Closed' and RANK_ORDER <> 1 THEN SALVAGE_RECOVERY_AMOUNT_SINCE_INCEPTION_CM
  ELSE SALVAGE_RECOVERY_AMOUNT_SINCE_REOPEN_CM END AS SALVAGE_RECOVERY_AMOUNT
,CASE WHEN ACCOUNTING_TIMESTAMP IS NOT NULL THEN SALVAGE_RECOVERY_AMOUNT_SINCE_INCEPTION ELSE SALVAGE_RECOVERY_AMOUNT_SINCE_INCEPTION_1 END AS SALVAGE_RECOVERY_AMOUNT_SINCE_INCEPTION
,CASE WHEN ACCOUNTING_TIMESTAMP IS NOT NULL THEN SALVAGE_RECOVERY_AMOUNT_SINCE_LAST_REOPEN ELSE SALVAGE_RECOVERY_AMOUNT_SINCE_LAST_REOPEN_1 END AS SALVAGE_RECOVERY_AMOUNT_SINCE_LAST_REOPEN

,CASE WHEN STATUS_NAME in ('Open','Closed') AND RANK_ORDER = 1 THEN SUBROGATION_RECOVERY_AMOUNT_CM
      WHEN STATUS_NAME  = 'Closed' and RANK_ORDER <> 1 THEN SUBROGATION_RECOVERY_AMOUNT_SINCE_INCEPTION_CM
  ELSE SUBROGATION_RECOVERY_AMOUNT_SINCE_REOPEN_CM END AS SUBROGATION_RECOVERY_AMOUNT
,CASE WHEN ACCOUNTING_TIMESTAMP IS NOT NULL THEN SUBROGATION_RECOVERY_AMOUNT_SINCE_INCEPTION ELSE SUBROGATION_RECOVERY_AMOUNT_SINCE_INCEPTION_1 END AS SUBROGATION_RECOVERY_AMOUNT_SINCE_INCEPTION
,CASE WHEN ACCOUNTING_TIMESTAMP IS NOT NULL THEN SUBROGATION_RECOVERY_AMOUNT_SINCE_LAST_REOPEN ELSE SUBROGATION_RECOVERY_AMOUNT_SINCE_LAST_REOPEN_1 END AS SUBROGATION_RECOVERY_AMOUNT_SINCE_LAST_REOPEN

,CASE WHEN STATUS_NAME in ('Open','Closed') AND RANK_ORDER = 1 THEN SUBROGATION_ADDITIONAL_PAYMENT_AMOUNT_CM
      WHEN STATUS_NAME  = 'Closed' and RANK_ORDER <> 1 THEN SUBROGATION_ADDITIONAL_PAYMENT_AMOUNT_SINCE_INCEPTION_CM
  ELSE SUBROGATION_ADDITIONAL_PAYMENT_AMOUNT_SINCE_REOPEN_CM END AS SUBROGATION_ADDITIONAL_PAYMENT_AMOUNT
,CASE WHEN ACCOUNTING_TIMESTAMP IS NOT NULL THEN SUBROGATION_ADDITIONAL_PAYMENT_AMOUNT_SINCE_INCEPTION ELSE SUBROGATION_ADDITIONAL_PAYMENT_AMOUNT_SINCE_INCEPTION_1 END AS SUBROGATION_ADDITIONAL_PAYMENT_AMOUNT_SINCE_INCEPTION
,CASE WHEN ACCOUNTING_TIMESTAMP IS NOT NULL THEN SUBROGATION_ADDITIONAL_PAYMENT_AMOUNT_SINCE_LAST_REOPEN ELSE SUBROGATION_ADDITIONAL_PAYMENT_AMOUNT_SINCE_LAST_REOPEN_1 END AS SUBROGATION_ADDITIONAL_PAYMENT_AMOUNT_SINCE_LAST_REOPEN

,CASE WHEN STATUS_NAME in ('Open','Closed') AND RANK_ORDER = 1 THEN ADJUSTER_EXPENSE_PAYMENT_AMOUNT_CM
      WHEN STATUS_NAME  = 'Closed' and RANK_ORDER <> 1 THEN ADJUSTER_EXPENSE_PAYMENT_AMOUNT_SINCE_INCEPTION_CM
  ELSE ADJUSTER_EXPENSE_PAYMENT_AMOUNT_SINCE_REOPEN_CM END AS ADJUSTER_EXPENSE_PAYMENT_AMOUNT
,CASE WHEN ACCOUNTING_TIMESTAMP IS NOT NULL THEN ADJUSTER_EXPENSE_PAYMENT_AMOUNT_SINCE_INCEPTION ELSE ADJUSTER_EXPENSE_PAYMENT_AMOUNT_SINCE_INCEPTION_1 END AS ADJUSTER_EXPENSE_PAYMENT_AMOUNT_SINCE_INCEPTION
,CASE WHEN ACCOUNTING_TIMESTAMP IS NOT NULL THEN ADJUSTER_EXPENSE_PAYMENT_AMOUNT_SINCE_LAST_REOPEN ELSE ADJUSTER_EXPENSE_PAYMENT_AMOUNT_SINCE_LAST_REOPEN_1 END AS ADJUSTER_EXPENSE_PAYMENT_AMOUNT_SINCE_LAST_REOPEN

,CASE WHEN STATUS_NAME in ('Open','Closed') AND RANK_ORDER = 1 THEN NET_LOSS_PAYMENT_AMOUNT_CM
      WHEN STATUS_NAME  = 'Closed' and RANK_ORDER <> 1 THEN NET_LOSS_PAYMENT_AMOUNT_SINCE_INCEPTION_CM
  ELSE NET_LOSS_PAYMENT_AMOUNT_SINCE_REOPEN_CM END AS NET_LOSS_PAYMENT_AMOUNT
,CASE WHEN ACCOUNTING_TIMESTAMP IS NOT NULL THEN NET_LOSS_PAYMENT_AMOUNT_SINCE_INCEPTION ELSE NET_LOSS_PAYMENT_AMOUNT_SINCE_INCEPTION_1 END AS NET_LOSS_PAYMENT_AMOUNT_SINCE_INCEPTION
,CASE WHEN ACCOUNTING_TIMESTAMP IS NOT NULL THEN NET_LOSS_PAYMENT_AMOUNT_SINCE_LAST_REOPEN ELSE NET_LOSS_PAYMENT_AMOUNT_SINCE_LAST_REOPEN_1 END AS NET_LOSS_PAYMENT_AMOUNT_SINCE_LAST_REOPEN

FROM
(
SELECT * FROM
(
SELECT * FROM
feature_snapshot_stg1
QUALIFY ROW_NUMBER() OVER( PARTITION BY CLAIM_NUMBER,EXPOSURE_PUBLICID_NK, CLAIM_SYMBOL_CODE
                          ORDER BY  CASE WHEN ACCOUNTING_TIMESTAMP <= '2022-11-30 23:59:59'THEN ACCOUNTING_TIMESTAMP
       ELSE RECORD_BEGIN_TIMESTAMP  END DESC   ) = 1
) WHERE STATUS_NAME in ('Open', 'Reopened')

--)))
--SELECT * FROM feature_snapshot;

union
SELECT * FROM
feature_snapshot_stg1 where ((ACCOUNTING_TIMESTAMP between '2022-11-01'and '2022-11-30 23:59:59')
                                    OR (RECORD_BEGIN_TIMESTAMP between '2022-11-01'and '2022-11-30 23:59:59')) and status_name = 'Closed'
QUALIFY ROW_NUMBER() OVER( PARTITION BY CLAIM_NUMBER,EXPOSURE_PUBLICID_NK, CLAIM_SYMBOL_CODE
                         ORDER BY  CASE WHEN ACCOUNTING_TIMESTAMP <= '2022-11-30 23:59:59'THEN ACCOUNTING_TIMESTAMP
  ELSE RECORD_BEGIN_TIMESTAMP  END DESC   ) = 1)
       )
)

--select * FROM feature_snapshot;
select

'2022-11-30'AS SNAP_DATE,
CLAIM_PUBLICID_NK,
CLAIM_NUMBER,
EXPOSURE_PUBLICID_NK,
S160_COVERAGE_CODE,
CLAIM_SYMBOL_CODE,
CREATE_TIMESTAMP,
CLOSE_TIMESTAMP,
REOPEN_TIMESTAMP,
NULL as PRIOR_CLOSE_TIMESTAMP,
NULL as PRIOR_REOPEN_TIMESTAMP,
PENDING_OR_CLOSED,
STATUS_NAME,
RESERVE_TYPE_NAME,
FEATURE_RESERVE_STATUS_CODE,
GROSS_LOSS_PAYMENT_AMOUNT as GROSS_LOSS_PAYMENT_CURRENT_MONTH_AMOUNT,
GROSS_LOSS_PAYMENT_AMOUNT_SINCE_LAST_REOPEN as GROSS_LOSS_PAYMENT_SINCE_LAST_REOPEN_AMOUNT,
GROSS_LOSS_PAYMENT_AMOUNT_SINCE_INCEPTION as GROSS_LOSS_PAYMENT_SINCE_INCEPTION_AMOUNT,
NET_LOSS_PAYMENT_AMOUNT AS NET_LOSS_PAYMENT_CURRENT_MONTH_AMOUNT,
NET_LOSS_PAYMENT_AMOUNT_SINCE_LAST_REOPEN as NET_LOSS_PAYMENT_SINCE_LAST_REOPEN_AMOUNT,
NET_LOSS_PAYMENT_AMOUNT_SINCE_INCEPTION as NET_LOSS_PAYMENT_SINCE_INCEPTION_AMOUNT,
EXPENSE_PAYMENT_AMOUNT AS EXPENSE_PAYMENT_CURRENT_MONTH_AMOUNT,
EXPENSE_PAYMENT_AMOUNT_SINCE_LAST_REOPEN as EXPENSE_PAYMENT_SINCE_LAST_REOPEN_AMOUNT,
EXPENSE_PAYMENT_AMOUNT_SINCE_INCEPTION as EXPENSE_PAYMENT_SINCE_INCEPTION_AMOUNT,
SALVAGE_RECOVERY_AMOUNT AS SALVAGE_RECOVERY_CURRENT_MONTH_AMOUNT,
SALVAGE_RECOVERY_AMOUNT_SINCE_LAST_REOPEN as SALVAGE_RECOVERY_SINCE_LAST_REOPEN_AMOUNT,
SALVAGE_RECOVERY_AMOUNT_SINCE_INCEPTION as SALVAGE_RECOVERY_SINCE_INCEPTION_AMOUNT,
SUBROGATION_RECOVERY_AMOUNT AS SUBROGATION_RECOVERY_CURRENT_MONTH_AMOUNT,
SUBROGATION_RECOVERY_AMOUNT_SINCE_LAST_REOPEN as SUBROGATION_RECOVERY_SINCE_LAST_REOPEN_AMOUNT,
SUBROGATION_RECOVERY_AMOUNT_SINCE_INCEPTION as SUBROGATION_RECOVERY_SINCE_INCEPTION_AMOUNT,
SUBROGATION_ADDITIONAL_PAYMENT_AMOUNT AS SUBROGATION_ADDITIONAL_PAYMENT_CURRENT_MONTH_AMOUNT,
SUBROGATION_ADDITIONAL_PAYMENT_AMOUNT_SINCE_LAST_REOPEN as SUBROGATION_ADDITIONAL_PAYMENT_SINCE_LAST_REOPEN_AMOUNT,
SUBROGATION_ADDITIONAL_PAYMENT_AMOUNT_SINCE_INCEPTION as SUBROGATION_ADDITIONAL_PAYMENT_SINCE_INCEPTION_AMOUNT,
NULL as STAFF_COUNSEL_PAYMENT_CURRENT_MONTH_AMOUNT,
NULL as STAFF_COUNSEL_PAYMENT_SINCE_LAST_REOPEN_AMOUNT,
NULL as STAFF_COUNSEL_PAYMENT_SINCE_INCEPTION_AMOUNT,
ADJUSTER_EXPENSE_PAYMENT_AMOUNT AS ADJUSTER_EXPENSE_PAYMENT_CURRENT_MONTH_AMOUNT,
ADJUSTER_EXPENSE_PAYMENT_AMOUNT_SINCE_LAST_REOPEN as ADJUSTER_EXPENSE_PAYMENT_SINCE_LAST_REOPEN_AMOUNT,
ADJUSTER_EXPENSE_PAYMENT_AMOUNT_SINCE_INCEPTION as ADJUSTER_EXPENSE_PAYMENT_SINCE_INCEPTION_AMOUNT,
NULL as DCC_PAYMENT_CURRENT_MONTH_AMOUNT,
NULL as DCC_PAYMENT_SINCE_LAST_REOPEN_AMOUNT,
NULL as DCC_PAYMENT_SINCE_INCEPTION_AMOUNT,
NEW_REPORTED_COUNT,
NEW_REOPENED_REPORTED_COUNT,
NEW_CLOSED_COUNT,
CLOSED_WITH_GROSS_LOSS_PAYMENT_COUNT,
CLOSED_WITH_NET_LOSS_PAYMENT_COUNT,
CLOSED_WITHOUT_GROSS_LOSS_PAYMENT_COUNT,
CLOSED_WITHOUT_NET_LOSS_PAYMENT_COUNT,
PENDING_COUNT,
CASE_RESERVE_LOSS_AMOUNT,
CASE_RESERVE_EXPENSE_AMOUNT,
CONVERT_TIMEZONE('UTC', 'America/New_York', SYSDATE()) as LOAD_TIMESTAMP,
'ATLAS' as RECORD_SOURCE,
--{{run_id()}} as GDH_ETL_RUN_ID

from feature_snapshot
;
